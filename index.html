<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>YouTube AI ì†Œì¬ ë¶„ì„ê¸° â€” JM Edition</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ê³ ê¸‰ í°íŠ¸ ì ìš© -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
        }

        .fade-in {
            animation: fadeIn .4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* Notion iframe í˜¸í™˜ì„ ìœ„í•´ ëª¨ë‹¬ fixed ì œê±° */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body class="text-gray-800">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-10 text-center fade-in">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">âœ¨ YouTube AI ì†Œì¬ ë¶„ì„ê¸°</h1>
            <p class="text-gray-600 text-lg">í”„ë¡ì‹œ ê¸°ë°˜ Â· API ë³´ì•ˆì™„ì „ Â· Notion/GitHub ì™„ì „í˜¸í™˜</p>
        </header>

        <!-- ğŸ” ê²€ìƒ‰ ì˜ì—­ -->
        <div class="bg-white shadow-lg rounded-2xl p-6 mb-8 fade-in">
            <div class="flex flex-col md:flex-row gap-4">
                <input id="searchInput"
                       type="text"
                       placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (ì˜ˆ: ì¬í…Œí¬, ìš”ë¦¬, ì‹œë‹ˆì–´, ìŒì•…...)"
                       class="flex-1 px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-500 outline-none"
                       onkeypress="if(event.key==='Enter') startSearch()">

                <button onclick="startSearch()"
                        class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-xl flex items-center justify-center gap-2 transition">
                    <span>ê²€ìƒ‰</span>
                </button>
            </div>
        </div>

        <!-- ê²°ê³¼ ì¹´ë“œ ì˜ì—­ -->
        <div id="resultsArea"
             class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 fade-in">
        </div>

        <!-- ë©”ì¸ ë¡œë”© -->
        <div id="mainLoader" class="hidden flex justify-center items-center py-12">
            <div class="loader border-4 border-indigo-500 border-t-transparent rounded-full w-10 h-10 animate-spin"></div>
        </div>
    </div>

    <!-- ğŸ“Œ AI ë¶„ì„ ëª¨ë‹¬ -->
    <div id="analysisModal"
        class="hidden modal-overlay bg-black/40 flex items-center justify-center z-50 p-4">

        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-hidden flex flex-col fade-in">
            <div class="p-5 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="text-lg font-semibold">âœ¨ AI ë¶„ì„ ê²°ê³¼</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    âœ–
                </button>
            </div>

            <div id="modalContent"
                 class="p-6 overflow-y-auto flex-1 prose max-w-none">
            </div>

            <div class="p-4 border-t bg-gray-50 text-right">
                <button onclick="closeModal()"
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-xl">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

<script>
/* ---------------------------------------------------------
   ğŸ”’ 1) í”„ë¡ì‹œ URL ì„¤ì • â€” JMë‹˜ ì „ìš©
--------------------------------------------------------- */
const PROXY_URL =
"https://script.google.com/macros/s/AKfycbwiNLhweA9H1w-LAKiwWkt3ZlGpEf_Q1L_UBILeTStnpoXvAkFFVR0Si2rtSSW1QSRv/exec";

/* ---------------------------------------------------------
   ğŸ” 2) ìœ íŠœë¸Œ ê²€ìƒ‰ ì‹œì‘
--------------------------------------------------------- */
async function startSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

    const results = document.getElementById('resultsArea');
    const loader = document.getElementById('mainLoader');
    results.innerHTML = "";
    loader.classList.remove('hidden');

    try {
        // 1) ê²€ìƒ‰
        const searchRes = await proxy({
            type: "youtube_search",
            query: query
        });

        const items = searchRes.items || [];
        if (items.length === 0) {
            results.innerHTML =
                '<p class="text-center text-gray-500 col-span-full">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // 2) ì˜ìƒ ID
        const videoIds = items.map(v => v.id.videoId).join(',');

        // 3) ì˜ìƒ ìŠ¤íƒ¯
        const stats = await proxy({
            type: "youtube_video_stats",
            videoIds: videoIds
        });

        // 4) ì±„ë„ ìŠ¤íƒ¯
        const channelIds = stats.items.map(v => v.snippet.channelId).join(',');
        const channels = await proxy({
            type: "youtube_channel_stats",
            channelIds: channelIds
        });

        renderCards(items, stats.items, channels.items);

    } catch (e) {
        alert("ì˜¤ë¥˜ ë°œìƒ: " + e);
    } finally {
        loader.classList.add('hidden');
    }
}

/* ---------------------------------------------------------
   ğŸ§© 3) í”„ë¡ì‹œ í˜¸ì¶œ í•¨ìˆ˜
--------------------------------------------------------- */
async function proxy(payload) {
    const res = await fetch(PROXY_URL, {
        method: "POST",
        body: JSON.stringify(payload)
    });
    return await res.json();
}

/* ---------------------------------------------------------
   ğŸ¨ 4) ì¹´ë“œ ë Œë”ë§
--------------------------------------------------------- */
function renderCards(searchItems, statItems, channelItems) {
    const CH = {};
    channelItems.forEach(c => CH[c.id] = c.statistics.subscriberCount);

    const area = document.getElementById('resultsArea');
    area.innerHTML = "";

    statItems.forEach((v, idx) => {
        const s = searchItems[idx];
        const sub = parseInt(CH[v.snippet.channelId] || 0);
        const view = parseInt(v.statistics.viewCount || 0);
        const perf = sub > 0 ? ((view / sub) * 100).toFixed(1) : 0;

        const card = `
            <div class="bg-white rounded-2xl shadow hover:shadow-xl transition overflow-hidden flex flex-col fade-in">
                <img src="${s.snippet.thumbnails.medium.url}" class="w-full h-48 object-cover">

                <div class="p-5 flex-1 flex flex-col">
                    <h3 class="font-semibold text-gray-900 line-clamp-2 mb-2">${s.snippet.title}</h3>
                    <p class="text-sm text-gray-500 mb-3">${s.snippet.channelTitle}</p>

                    <div class="grid grid-cols-3 text-center text-xs bg-gray-50 rounded-xl p-2 mb-4">
                        <div><p class="text-gray-400">ì¡°íšŒìˆ˜</p><p>${formatK(view)}</p></div>
                        <div><p class="text-gray-400">êµ¬ë…ì</p><p>${formatK(sub)}</p></div>
                        <div><p class="text-gray-400">ì„±ê³¼</p><p class="font-bold text-indigo-600">${perf}%</p></div>
                    </div>

                    <button onclick="analyzeVideo('${v.id}', '${s.snippet.title.replace(/'/g, "\\'")}')"
                        class="mt-auto bg-indigo-50 text-indigo-600 hover:bg-indigo-100 py-2 rounded-xl font-semibold">
                        âœ¨ AI ë¶„ì„
                    </button>
                </div>
            </div>
        `;
        area.innerHTML += card;
    });
}

function formatK(n) {
    if (n > 999999) return (n/1000000).toFixed(1) + "M";
    if (n > 999) return (n/1000).toFixed(1) + "K";
    return n;
}

/* ---------------------------------------------------------
   âœ¨ 5) AI ë¶„ì„ ì‹¤í–‰
--------------------------------------------------------- */
async function analyzeVideo(videoId, title) {
    const modal = document.getElementById('analysisModal');
    const box = document.getElementById('modalContent');

    modal.classList.remove('hidden');
    box.innerHTML = `
        <div class="text-center py-20">
            <div class="loader border-4 border-indigo-500 border-t-transparent rounded-full w-10 h-10 mx-auto animate-spin"></div>
            <p class="mt-4 text-gray-600 font-medium">AI ë¶„ì„ ì¤‘...</p>
        </div>
    `;

    try {
        // ëŒ“ê¸€ 100ê°œ ìˆ˜ì§‘
        const comments = await proxy({
            type: "youtube_comments",
            videoId: videoId
        });

        const list = comments.items?.map(c =>
            c.snippet.topLevelComment.snippet.textDisplay
        ) || [];

        // ê³ ê¸‰ Gemini ë¶„ì„
        const prompt = `
ì•„ë˜ëŠ” ìœ íŠœë¸Œ ì˜ìƒì˜ ì£¼ìš” ëŒ“ê¸€ë“¤ì…ë‹ˆë‹¤.
ê° ëŒ“ê¸€ë“¤ì˜ ê°ì •, ì£¼ì œ, ê´€ì‹¬ í¬ì¸íŠ¸ë¥¼ ë¶„ì„í•˜ê³ 
1) ì‹œì²­ìë“¤ì´ ì—´ê´‘í•œ ìš”ì†Œ  
2) ë¶€ì¡±í•˜ê±°ë‚˜ ê°œì„ ë˜ê¸¸ ì›í•˜ëŠ” ìš”ì†Œ  
3) JMì˜ ìƒˆ ì½˜í…ì¸  ì•„ì´ë””ì–´ 3ê°œ  
4) ê° ì•„ì´ë””ì–´ì˜ ì¸ë„¤ì¼ ë¬¸êµ¬ / ì œëª© ì˜ˆì‹œ  
ë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•˜ì„¸ìš”.

ì˜ìƒ ì œëª©: "${title}"

ëŒ“ê¸€ë“¤:
${JSON.stringify(list, null, 2)}
`;

        const result = await proxy({
            type: "gemini_analyze",
            prompt: prompt
        });

        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "ê²°ê³¼ ì—†ìŒ";

        box.innerHTML = markdownToHtml(text);

    } catch (e) {
        box.innerHTML =
         `<p class="text-red-500">ì˜¤ë¥˜ ë°œìƒ: ${e}</p>`;
    }
}

function closeModal() {
    document.getElementById('analysisModal').classList.add('hidden');
}

/* ---------------------------------------------------------
   ğŸ“ 6) Markdown ê°„ë‹¨ ë³€í™˜ê¸°
--------------------------------------------------------- */
function markdownToHtml(md) {
    return md
        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold">$1</h3>')
        .replace(/^## (.*$)/gim, '<h2 class="text-xl font-bold">$1</h2>')
        .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold">$1</h1>')
        .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
        .replace(/\n/gim, "<br>");
}
</script>

</body>
</html>
